---
# Create application directory
- name: Create WordPress application directory
  become: yes
  file:
    path: /opt/wordpress
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

# Copy Docker Compose files
- name: Copy Docker Compose file
  become: yes
  copy:
    src: docker-compose.yml
    dest: /opt/wordpress/docker-compose.yml
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Copy environment file
  become: yes
  copy:
    src: .env
    dest: /opt/wordpress/.env
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'

# Generate random secrets
- name: Generate random WordPress database password
  set_fact:
    wordpress_db_password: "{{ lookup('password', '/dev/null', length=16, chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789') }}"

- name: Generate random MySQL user password
  set_fact:
    mysql_user_password: "{{ lookup('password', '/dev/null', length=16, chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789') }}"

- name: Generate random MySQL root password
  set_fact:
    mysql_root_password: "{{ lookup('password', '/dev/null', length=16, chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789') }}"

- name: Generate random WordPress admin password
  set_fact:
    wordpress_admin_password: "{{ lookup('password', '/dev/null', length=16, chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789!@#$%^&*()-_=+') }}"

# Update environment file with generated passwords
- name: Update environment file with WordPress DB password
  become: yes
  lineinfile:
    path: /opt/wordpress/.env
    regexp: '^WORDPRESS_DB_PASSWORD='
    line: "WORDPRESS_DB_PASSWORD={{ wordpress_db_password }}"

- name: Update environment file with MySQL user password
  become: yes
  lineinfile:
    path: /opt/wordpress/.env
    regexp: '^MYSQL_PASSWORD='
    line: "MYSQL_PASSWORD={{ mysql_user_password }}"

- name: Update environment file with MySQL root password
  become: yes
  lineinfile:
    path: /opt/wordpress/.env
    regexp: '^MYSQL_ROOT_PASSWORD='
    line: "MYSQL_ROOT_PASSWORD={{ mysql_root_password }}"

- name: Update environment file with WordPress admin password
  become: yes
  lineinfile:
    path: /opt/wordpress/.env
    regexp: '^WP_ADMIN_PASSWORD='
    line: "WP_ADMIN_PASSWORD={{ wordpress_admin_password }}"

# Deploy WordPress with Docker Compose
- name: Stop existing WordPress containers
  become: yes
  shell: cd /opt/wordpress && docker-compose down
  ignore_errors: yes

- name: Start WordPress with Docker Compose
  become: yes
  shell: cd /opt/wordpress && docker-compose up -d

- name: Wait for WordPress to be ready
  wait_for:
    port: 8080
    host: "{{ ansible_host | default('localhost') }}"
    timeout: 300

# Update WordPress site and admin URLs to use provided domain with HTTPS
- name: Update WordPress site and admin URLs to use provided domain with HTTPS
  become: yes
  shell: |
    docker exec wordpress wp option update siteurl "https://{{ site_domain }}"
    docker exec wordpress wp option update home "https://{{ site_domain }}"
  args:
    warn: false
  environment:
    WORDPRESS_DB_PASSWORD: "{{ wordpress_db_password }}"
    MYSQL_PASSWORD: "{{ mysql_user_password }}"
    MYSQL_ROOT_PASSWORD: "{{ mysql_root_password }}"
  when: site_domain is defined

# Display important information
- name: Display WordPress access information
  debug:
    msg:
      - "‚úÖ WordPress has been deployed successfully!"
      - "üåê WordPress URL: http://{{ ansible_host | default('localhost') }}:8080"
      - "üë§ WordPress Admin User: {{ lookup('env', 'WP_ADMIN_USER') | default('admin') }}"
      - "üîë WordPress Admin Password: {{ wordpress_admin_password }}"
      - "üîë WordPress DB Password: {{ wordpress_db_password }}"
      - "üîë MySQL User Password: {{ mysql_user_password }}"
      - "üîë MySQL Root Password: {{ mysql_root_password }}"
      - "‚ö†Ô∏è Please save these credentials in a secure location!"
