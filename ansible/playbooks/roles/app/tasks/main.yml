---


# Create application directory
- name: Create WordPress application directory
  become: yes
  file:
    path: /opt/wordpress
    state: directory
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0755'

# Copy Docker Compose files
- name: Copy Docker Compose file
  become: yes
  copy:
    src: docker-compose.yml
    dest: /opt/wordpress/docker-compose.yml
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Copy environment file
  become: yes
  copy:
    src: .env
    dest: /opt/wordpress/.env
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'

# Update environment variables with actual passwords
- name: Generate random WordPress database password
  set_fact:
    wordpress_db_password: "{{ lookup('password', '/dev/null', length=16, chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789') }}"

- name: Generate random MySQL user password
  set_fact:
    mysql_user_password: "{{ lookup('password', '/dev/null', length=16, chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789') }}"

- name: Generate random MySQL root password
  set_fact:
    mysql_root_password: "{{ lookup('password', '/dev/null', length=16, chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789') }}"


# Update environment variables with actual passwords
- name: Generate random WordPress database password
  set_fact:
    wordpress_db_password: "{{ lookup('password', '/dev/null', length=16, chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789') }}"

- name: Generate random MySQL user password
  set_fact:
    mysql_user_password: "{{ lookup('password', '/dev/null', length=16, chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789') }}"

- name: Generate random MySQL root password
  set_fact:
    mysql_root_password: "{{ lookup('password', '/dev/null', length=16, chars='abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789') }}"


# Deploy WordPress with Docker Compose
- name: Stop existing WordPress containers
  become: yes
  shell: cd /opt/wordpress && docker-compose down
  ignore_errors: yes

- name: Start WordPress with Docker Compose
  become: yes
  shell: cd /opt/wordpress && docker-compose up -d

- name: Wait for WordPress to be ready
  wait_for:
    port: 80
    host: "{{ ansible_host | default('localhost') }}"
    timeout: 300

# Display important information
- name: Display WordPress access information
  debug:
    msg:
      - "‚úÖ WordPress has been deployed successfully!"
      - "üåê WordPress URL: http://{{ ansible_host | default('localhost') }}"
      - "üõ† PhpMyAdmin URL: http://{{ ansible_host | default('localhost') }}:8080"
      - "üîë WordPress DB Password: {{ wordpress_db_password }}"
      - "üîë MySQL User Password: {{ mysql_user_password }}"
      - "üîë MySQL Root Password: {{ mysql_root_password }}"
      - "‚ö†Ô∏è Please save these passwords in a secure location!"
